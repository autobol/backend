
  Build:
    stage: build
    image:
      name: gcr.io/kaniko-project/executor:debug
      entrypoint: [""]
    script:
      - apt install git
      - apt install python
      - VERSION_TAG=$(python3 version.py "$CI_COMMIT_MESSAGE" $(git describe --tags) $CI_COMMIT_SHORT_SHA)
      - mkdir -p /kaniko/.docker
      - echo "{\"auths\":{\"$DOCKER_REGISTR":{\"auth\":\"$(printf "%s:%s" "autobol" "8cba6079-70ca-46a2-99ad-2d68562d1f2e" | base64 | tr -d '\n')\"}}}" > /kaniko/.docker/config.json
      - >-
        /kaniko/executor
        --context "${CI_PROJECT_DIR}"
        --build-arg "GRADLE_VERSION=$GRADLE_VERSION"
        --dockerfile "${CI_PROJECT_DIR}/Dockerfile"
        --destination "$DOCKER_REGISTRY/backend:$VERSION_TAG"
        --destination "$DOCKER_REGISTRY/backend:latest"
      - GIT_TAG=$VERSION_TAG-$CI_COMMIT_SHORT_SHA.$CI_PIPELINE_IID 
      - git tag $GIT_TAG && git push origin $GIT_TAG
    only: ["master"]
