.build_temaplte: &build_template
  tags: ["docker"]
  services: ["docker:19.03.13-dind"]
  image: docker

Pre-build:
  stage: pre-build
  <<: *build_template
  script:
    - docker build `
     `-t $DOCKER_REGISTRY/image_for_build_back:latest `
     `-f ./Dockerfile.pre-build `
     `--build-arg ALPINE_VERSION=$ALPINE_VERSION .
    - echo $DOCKER_PASS | docker login -u $DOCKER_USER --password-stdin
    - docker push $DOCKER_REGISTRY/image_for_build_back:latest
  rules:
    - if: '$RUN_REBUILD_IMAGE_FOR_BUILD != "no"'
      when: always
    - when: never

Build:
  stage: build
  <<: *build_template
  before_script:
    - apk add git && apk add python3
    - project_url=$(echo $CI_PROJECT_URL | sed 's/https:\/\///')
    - git remote set-url origin https://oauth2:$GITLAB_TOKEN@$project_url
  script:
    - VERSION_TAG=$(python3 version.py "$CI_COMMIT_MESSAGE" $(git describe --tags))
    - GIT_TAG=$VERSION_TAG-$CI_COMMIT_SHORT_SHA
    - git tag $GIT_TAG && git push origin $GIT_TAG
    - docker build `
     `-t $DOCKER_REGISTRY/backend `
     `--build-arg GRADLE_VERSION=$GRADLE_VERSION `
     `--build-arg APP_VERSION=$VERSION_TAG .
    - docker tag `
     `$DOCKER_REGISTRY/backend:latest `
     `$DOCKER_REGISTRY/backend:$VERSION_TAG
    - echo $DOCKER_PASS | docker login -u $DOCKER_USER --password-stdin
    - docker push $DOCKER_REGISTRY/backend:$VERSION_TAG
  only: ["master"]
